<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.js"></script>
    <style>
        *{
            -moz-user-select: none;
            -khtml-user-select: none;
            -ms-user-select: none;
            -o-user-select: none;
            -webkit-user-select: none;
            user-select: none;
            -webkit-user-drag: none;
            -moz-user-drag: none;
            -o-user-drag: none;
            -khtml-user-drag: none;
            -ms-user-drag: none;
            user-drag: none;
        }
        #playfield{
            position: absolute;
            top: 100px;
            left: 100px;
            width: 400px;
            height: 400px;
            background: white;
        }
        .back{
            position: absolute;
            width: 100px;
            height: 100px;
            background: gray;
            outline: 1px solid black;
        }
        .thing{
            position: absolute;
            width: 100px;
            height: 100px;
            background: transparent;
            color: black;
            text-align: center;
            font: 48px/96px Arial;
        }
        .thing.t2{
            background: #18df00;
        }
        .thing.t2:after{
            content: '2'
        }
        .thing.t4{
            background: #5a9900;
        }
        .thing.t4:after{
            content: '4'
        }
        .thing.t8{
            background: #8c8e00;
        }
        .thing.t8:after{
            content: '8'
        }
        .thing.t16{
            background: #d38200;
        }
        .thing.t16:after{
            content: '16'
        }
        .thing.t32{
            background: #ae3900;
        }
        .thing.t32:after{
            content: '32'
        }
        .thing.t64{
            background: #931269;
        }
        .thing.t64:after{
            content: '64'
        }
        .thing.t128{
            background: #0a034c;
        }
        .thing.t128:after{
            content: '128'
        }
        /* и так далее */

    </style>
    <script>

        /*
         Пример игры: http://gabrielecirulli.github.io/2048/ только в нем ходы делаются с помощью клавиатуры
         Правила игры.
         В каждом раунде появляется плитка номинала «2» (с вероятностью 90 %) или «4» (с вероятностью 10 %).
         В начале игры на поле находится 1 клетка.
         Чтобы сделать ход, игрок должен зажать левую кнопку мыши и переместить курсор в одном из четырех направлений.
         Все клетку с числами при этом сдивгаются в этом направлении до упора.
         Если при этом две плитки одного номинала «налетают» одна на другую, то они слипаются в одну,
         номинал которой равен сумме соединившихся плиток.
         После каждого хода на свободной секции поля появляется новая плитка номиналом «2» или «4».
         Если при нажатии кнопки местоположение плиток или их номинал не изменится, то ход не совершается.
         Тоесть новую плитку в этом случае добавлять не нужно.
         За каждое соединение игровые очки увеличиваются на номинал получившейся плитки.
         Игра заканчивается поражением, если после очередного хода невозможно совершить действие.
         */
        
        class State {
          constructor(playFieldSize) {
            this.playFieldSize = playFieldSize;
            this.gameOver = false;
            this.tiles = [];
            for (var i = 0; i < this.playFieldSize; i++) {
              this.tiles[i] = new Array(this.playFieldSize);
            }
            this.buildFreeCells();
            this.addNewTile();
          }
          
          buildFreeCells() {
            this.freeCells = [];
            for (var i = 0; i < this.playFieldSize; i++) {
              for (var j = 0; j < this.playFieldSize; j++) {
                if (this.tiles[i][j] === undefined) {
                  this.freeCells.push({
                    row: i,
                    column: j,
                  });
                }
              }
            }
          }

          refreshTilesNextPosition() {
            for (var i = 0; i < this.playFieldSize; i++) {
              for (var j = 0; j < this.playFieldSize; j++) {
                if (this.tiles[i][j] !== undefined) {
                  this.tiles[i][j].row = i;
                  this.tiles[i][j].column = j;
                }
              }
            }
          }

          addNewTile() {
            const randomIndex = Math.floor(Math.random() * this.freeCells.length);
            const cell = this.freeCells[randomIndex];
            this.freeCells.splice(randomIndex, 1);
            cell.value = Math.random() > 0.9 ? 4 : 2;
            cell.id = Date.now();
            this.tiles[cell.row][cell.column] = cell;
            this.newTile = cell;
          }
          
          next(direction) {

            function getTableRow(table, n) {
              return table[n].slice();
            }

            function getTableColumn(table, n) {
              const column = [];
              for (var i = 0; i < table.length; i++) {
                  column.push(table[i][n]);
              }
              return column;
            }

            function attract(arr) {
              let vacantPos;
              for (let i = 0; i < arr.length; i++) {
                if (arr[i] === undefined) {
                  vacantPos = i;
                  break;
                }
              }
              if (vacantPos === undefined) {
                return;
              }
              for (let i = vacantPos + 1; i < arr.length; i++) {
                if (arr[i] !== undefined) {
                  arr[vacantPos] = arr[i];
                  delete arr[i];
                  vacantPos++;
                }
              }
            }

            function getRotatedTable(table, direction) {
              const tableCopy = [];
              if (direction === 'left' || direction === 'right') {
                for (var i = 0; i < table.length; i++) {
                  tableCopy[i] = getTableRow(table, i);
                  if (direction === 'right') {
                    tableCopy[i].reverse();
                  }
                }
              } else {
                for (var i = 0; i < table.length; i++) {
                  tableCopy[i] = getTableColumn(table, i);
                  if (direction === 'bottom') {
                    tableCopy[i].reverse();
                  }
                }
              }
              return tableCopy;
            }

            function getUnrotatedTable(table, direction) {
              const tableCopy = [];
              if (direction === 'bottom' || direction === 'right') {
                for (var i = 0; i < table.length; i++) {
                  table[i].reverse();
                }
              }
              if (direction === 'left' || direction === 'right') {
                for (var i = 0; i < table.length; i++) {
                  tableCopy[i] = getTableRow(table, i);
                }
              } else {
                for (var i = 0; i < table.length; i++) {
                  tableCopy[i] = getTableColumn(table, i);
                }
              }
              return tableCopy;
            }

            const tilesCopy = getRotatedTable(this.tiles, direction);
            for (var i = 0; i < this.playFieldSize; i++) {
              attract(tilesCopy[i]);
            }
            this.tiles = getUnrotatedTable(tilesCopy, direction);

            this.refreshTilesNextPosition();
            this.buildFreeCells();
            if (this.freeCells.length) {
              this.addNewTile();
            } else {
              this.gameOver = true;
            }
            
          }

        }

        
        $(document).ready(function () {
          var $playfield = $('#playfield');
          var mousedown = false;

          function getTileStyleClass({ value }) {
            return `thing t${value}`;
          }
          function getCellStylePosition({ row, column }) {
            var top = row * 100;
            var left = column * 100;
            return `top: ${top}px; left: ${left}px;`;
          }

          function renderNewTile(tile) {
            if (tile !== undefined) {
              $('<div/>', {
                id: tile.id,
                class: getTileStyleClass(tile),
                style: getCellStylePosition(tile),
              }).appendTo($playfield);
            }
          }
          
          function renderTileTransition(state) {
            for (var i = 0; i < state.playFieldSize; i++) {
              for (var j = 0; j < state.playFieldSize; j++) {
                const tile = state.tiles[i][j];
                if (tile !== undefined) {
                  $(`#${tile.id}`).attr({
                    class: getTileStyleClass(tile),
                    style: getCellStylePosition(tile),
                  });

                }
              }
            }
          }


          function getDirection(event) {
            var shiftX = 0, shiftY = 0, direction;
            shiftX = event.pageX - getDirection.mousedown.pageX;
            shiftY = event.pageY - getDirection.mousedown.pageY;
            if (Math.abs(shiftX) > Math.abs(shiftY)) {
              return shiftX > 0 ? 'right' : 'left';
            } else {
              return shiftY > 0 ? 'bottom' : 'top';
            }
          }

          $playfield.unbind('mousedown').mousedown(function (event) {
              mousedown = true;
              getDirection.mousedown = event;
          });
          $playfield.unbind('mouseup').mouseup(function (event) {
              mousedown = false;
              let direction = getDirection(event);
              console.log('UP: direction =', direction);
              state.next(direction);
              if (state.gameOver) {
                return;
              }
              renderTileTransition(state);
              renderNewTile(state.newTile);
              console.log(state);
          });

          const state = new State(4);
          renderNewTile(state.newTile);
          console.log(state);
        });

    </script>
</head>
<body>
<div id="playfield">
    <div class="back" style="top: 0px; left: 0px;"></div>
    <div class="back" style="top: 100px; left: 0px;"></div>
    <div class="back" style="top: 200px; left: 0px;"></div>
    <div class="back" style="top: 300px; left: 0px;"></div>
    <div class="back" style="top: 0px; left: 100px;"></div>
    <div class="back" style="top: 100px; left: 100px;"></div>
    <div class="back" style="top: 200px; left: 100px;"></div>
    <div class="back" style="top: 300px; left: 100px;"></div>
    <div class="back" style="top: 0px; left: 200px;"></div>
    <div class="back" style="top: 100px; left: 200px;"></div>
    <div class="back" style="top: 200px; left: 200px;"></div>
    <div class="back" style="top: 300px; left: 200px;"></div>
    <div class="back" style="top: 0px; left: 300px;"></div>
    <div class="back" style="top: 100px; left: 300px;"></div>
    <div class="back" style="top: 200px; left: 300px;"></div>
    <div class="back" style="top: 300px; left: 300px;"></div>

</div>
</body>
</html>